<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - Semulight</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,300;0,400;1,600&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      padding-top: 80px;
    }

    nav {
      width: 100%;
      background: url('Web\ \(21\).svg');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px 5%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      transition: top 0.3s ease;
    }

    .nav-logo {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 100px;
      height: auto;
      margin-right: 20px;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 1.5em;
      align-items: center;
    }

    nav ul li {
      position: relative;
    }

    nav ul li a {
      color: black;
      text-decoration: none;
      font-weight: bold;
      font-family: 'Poppins', sans-serif;
      padding: 8px 12px;
      display: block;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }

    nav ul li > a:hover {
      background: linear-gradient(45deg, #8a2be2, #9400d3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #userRole {
      background: rgba(0, 174, 140, 0.2);
      color: #9B4DCA;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 1em;
      font-weight: bold;
      text-align: center;
      display: inline-block;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .hamburger {
      display: none;
      flex-direction: column;
      cursor: pointer;
    }

    .hamburger div {
      width: 25px;
      height: 3px;
      background: black;
      margin: 4px;
      transition: 0.3s;
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
        position: absolute;
        top: 60px;
        right: 20px;
        background: white;
        flex-direction: column;
        padding: 10px;
        border: 1px solid #ddd;
      }

      .nav-links.active {
        display: flex;
      }

      .hamburger {
        display: flex;
      }
    }

    .profile-container {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #00AE8C;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.5em;
      font-weight: bold;
      margin-right: 20px;
    }

    .profile-info h1 {
      color: #00AE8C;
      margin-bottom: 5px;
    }

    .profile-info p {
      color: #666;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      margin-right: 5px;
    }

    .badge-green {
      background-color: #00AE8C;
      color: white;
    }

    .badge-blue {
      background-color: #2196F3;
      color: white;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 10px;
    }

    .stat-card p {
      font-size: 2em;
      font-weight: bold;
      color: #00AE8C;
    }

    .stat-card .progress {
      height: 5px;
      background: #e0e0e0;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }

    .stat-card .progress-bar {
      height: 100%;
      background: #00AE8C;
      border-radius: 5px;
    }

    .profile-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-weight: 600;
      color: #666;
    }

    .tab-btn.active {
      border-bottom: 3px solid #00AE8C;
      color: #00AE8C;
    }

    .tab-content {
      display: none;
      padding: 20px 0;
    }

    .tab-content.active {
      display: block;
    }

    .donation-history {
      max-height: 600px;
      overflow-y: auto;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .history-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .summary-card h4 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .summary-card p {
      font-size: 1.5em;
      font-weight: bold;
      color: #00AE8C;
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.3s ease;
      background: white;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .history-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .history-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e9f7f3;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #00AE8C;
      font-size: 1.5em;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .history-details {
      flex: 1;
      min-width: 0;
    }

    .history-details h4 {
      margin-bottom: 5px;
      color: #333;
      font-size: 1.1em;
    }

    .history-details p {
      color: #666;
      font-size: 0.9em;
      margin: 2px 0;
    }

    .history-meta {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8em;
      color: #888;
    }

    .history-points {
      text-align: right;
      flex-shrink: 0;
      margin-left: 15px;
    }

    .history-points span {
      font-weight: bold;
      color: #00AE8C;
      font-size: 1.2em;
      display: block;
    }

    .history-points .points-label {
      font-size: 0.8em;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #666;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .empty-state i {
      font-size: 4em;
      margin-bottom: 20px;
      color: #ddd;
    }

    .empty-state h3 {
      color: #999;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #777;
      line-height: 1.5;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading i {
      font-size: 2em;
      margin-bottom: 10px;
      color: #00AE8C;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #c62828;
    }

    .level-progress {
      margin-top: 10px;
    }

    .level-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .event-badge {
      background: #e7f3ff;
      color: #007bff;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      display: inline-block;
      margin-right: 5px;
    }

    .quantity-badge {
      background: #e7f7f3;
      color: #00AE8C;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      display: inline-block;
    }

    .station-badge {
      background: #f8f9fa;
      color: #666;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      display: inline-block;
    }

    .edit-profile-btn {
      padding: 10px 20px;
      background: #00AE8C;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }

    .edit-profile-btn:hover {
      background: #008c6f;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }

      .profile-stats {
        grid-template-columns: 1fr;
      }

      .profile-tabs {
        flex-direction: column;
      }

      .tab-btn {
        text-align: left;
        border-bottom: 1px solid #ddd;
        border-left: 3px solid transparent;
      }

      .tab-btn.active {
        border-left: 3px solid #00AE8C;
        border-bottom: 1px solid #ddd;
      }

      .history-item {
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      .history-icon {
        margin-right: 0;
        margin-bottom: 15px;
      }

      .history-points {
        text-align: center;
        margin-left: 0;
        margin-top: 15px;
      }

      .history-meta {
        justify-content: center;
      }

      .history-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .history-summary {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="menu.html" class="logo-link">
        <img src="Web (44).svg" alt="Logo" class="logo" />
    </a>

    <ul class="nav-links">
        <li><a href="Letsdonate.html">LET'S DONATE</a></li>
        <li><a href="leaderboards.html">LEADERBOARDS</a></li>
        <li><a href="chart.html">CHARTS</a></li>
        <li><a href="forum.html">FORUM</a></li>
        <li><a href="ContactUs.html">CONTACT US</a></li>
        <li><a href="AboutUs.html">ABOUT US</a></li>
        <li><a href="quiz chemistry.html">QUIZ</a></li>
        <li><a href="user.html">USER</a></li>
        <li><a href="signup.html" id="signUpBtn">SIGN UP</a></li>
        <li><a href="login.html" id="logInBtn">LOG IN</a></li>
        <li><a href="javascript:void(0)" id="logOutBtn" style="display: none;">LOG OUT</a></li>
        <li id="userRole" style="display: none; font-family: 'Poppins', sans-serif;"></li>
    </ul>

    <div class="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </nav>

  <script>
  let prevScrollPos = window.pageYOffset;
  window.onscroll = function() {
    let currentScrollPos = window.pageYOffset;
    const nav = document.querySelector('nav');
    if (prevScrollPos > currentScrollPos) {
      nav.style.top = "0";
    } else {
      nav.style.top = "-120px";
    }
    prevScrollPos = currentScrollPos;
  };

  // Hamburger menu functionality
  document.querySelector('.hamburger').addEventListener('click', function() {
    document.querySelector('.nav-links').classList.toggle('active');
  });
  </script>

  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar" id="userAvatar">
        <i class="fas fa-user"></i>
      </div>
      <div class="profile-info">
        <h1 id="userName">Loading...</h1>
        <p id="userEmail">Loading...</p>
        <p>Member since: <span id="memberSince">Loading...</span></p>
        <div>
          <span class="badge badge-green" id="userLevel">Loading...</span>
          <span class="badge badge-blue" id="userRank">User</span>
        </div>
        <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
      </div>
    </div>

    <div class="profile-stats">
      <div class="stat-card">
        <h3>Total Points</h3>
        <p id="totalPoints">0</p>
        <div class="level-info">
          <span>Level <span id="currentLevel">1</span></span>
          <span><span id="currentXP">0</span>/<span id="nextLevelXP">100</span> XP</span>
        </div>
        <div class="progress">
          <div class="progress-bar" id="levelProgress" style="width: 0%"></div>
        </div>
      </div>
      <div class="stat-card">
        <h3>Donations Made</h3>
        <p id="totalDonations">0</p>
        <div class="level-info">
          <span>Quantity</span>
          <span id="totalQuantity">0 kg</span>
        </div>
      </div>
      <div class="stat-card">
        <h3>Events Joined</h3>
        <p id="eventsJoined">0</p>
        <div class="level-info">
          <span>Unique Events</span>
          <span id="uniqueEvents">0</span>
        </div>
      </div>
      <div class="stat-card">
        <h3>Forum Activity</h3>
        <p id="forumRegistrations">0</p>
        <div class="level-info">
          <span>Registrations</span>
          <span id="forumEvents">0 events</span>
        </div>
      </div>
    </div>

    <div class="points-breakdown" id="pointsBreakdown">
      <h3>Points Breakdown</h3>
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading points data...</p>
      </div>
    </div>

    <div class="profile-tabs">
      <button class="tab-btn active" data-tab="donations">Donation History</button>
      <button class="tab-btn" data-tab="events">Events</button>
      <button class="tab-btn" data-tab="forum">Forum Activity</button>
      <button class="tab-btn" data-tab="achievements">Achievements</button>
      <button class="tab-btn" data-tab="settings">Account Settings</button>
    </div>

    <div class="tab-content active" id="donations-tab">
      <div class="donation-history">
        <div class="history-header">
          <h3>Your Donation History</h3>
        </div>
        <div class="history-summary" id="historySummary" style="display: none;">
          <div class="summary-card">
            <h4>Total Donations</h4>
            <p id="summaryTotal">0</p>
          </div>
          <div class="summary-card">
            <h4>Total Quantity</h4>
            <p id="summaryQuantity">0 kg</p>
          </div>
          <div class="summary-card">
            <h4>Total Points</h4>
            <p id="summaryPoints">0 pts</p>
          </div>
          <div class="summary-card">
            <h4>Average per Donation</h4>
            <p id="summaryAverage">0 kg</p>
          </div>
        </div>
        <div id="donationList">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading donation history...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="events-tab">
      <div class="empty-state">
        <i class="fas fa-calendar-alt"></i>
        <h3>Events Feature Coming Soon</h3>
        <p>We're working on bringing you the best events experience. Stay tuned!</p>
      </div>
    </div>

    <div class="tab-content" id="forum-tab">
      <div class="forum-activity">
        <div class="history-header">
          <h3>Your Forum Activity</h3>
        </div>
        <div class="history-summary" id="forumSummary" style="display: none;">
          <div class="summary-card">
            <h4>Total Registrations</h4>
            <p id="forumTotal">0</p>
          </div>
          <div class="summary-card">
            <h4>Unique Events</h4>
            <p id="forumUnique">0</p>
          </div>
          <div class="summary-card">
            <h4>Total Points</h4>
            <p id="forumPoints">0 pts</p>
          </div>
          <div class="summary-card">
            <h4>Points per Registration</h4>
            <p>1 pt</p>
          </div>
        </div>
        <div id="forumList">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading forum activity...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="achievements-tab">
      <div class="empty-state">
        <i class="fas fa-trophy"></i>
        <h3>Achievements Feature Coming Soon</h3>
        <p>We're preparing exciting achievements for you. Coming soon!</p>
      </div>
    </div>

    <div class="tab-content" id="settings-tab">
      <div class="settings-form">
        <h3>Account Settings</h3>
        <form id="profileForm">
          <div style="margin-bottom: 15px;">
            <label for="displayName">Display Name</label>
            <input type="text" id="displayName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label for="email">Email Address</label>
            <input type="email" id="email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;" readonly>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label for="state">State</label>
            <select id="state" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
              <option value="">Select State</option>
              <option value="Johor">Johor</option>
              <option value="Kedah">Kedah</option>
              <option value="Kelantan">Kelantan</option>
              <option value="Melaka">Melaka</option>
              <option value="Negeri Sembilan">Negeri Sembilan</option>
              <option value="Pahang">Pahang</option>
              <option value="Perak">Perak</option>
              <option value="Perlis">Perlis</option>
              <option value="Pulau Pinang">Pulau Pinang</option>
              <option value="Sabah">Sabah</option>
              <option value="Sarawak">Sarawak</option>
              <option value="Selangor">Selangor</option>
              <option value="Terengganu">Terengganu</option>
              <option value="Wilayah Persekutuan Kuala Lumpur">Wilayah Persekutuan Kuala Lumpur</option>
              <option value="Wilayah Persekutuan Labuan">Wilayah Persekutuan Labuan</option>
              <option value="Wilayah Persekutuan Putrajaya">Wilayah Persekutuan Putrajaya</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label for="notifications">Notification Preferences</label>
            <div style="margin-top: 10px;">
              <input type="checkbox" id="emailNotifications">
              <label for="emailNotifications">Email notifications</label>
            </div>
            <div>
              <input type="checkbox" id="smsNotifications">
              <label for="smsNotifications">SMS notifications</label>
            </div>
          </div>
          
          <button type="submit" class="edit-profile-btn">Save Changes</button>
        </form>
        
        <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
          <h3>Change Password</h3>
          <form id="passwordForm">
            <div style="margin-bottom: 15px;">
              <label for="currentPassword">Current Password</label>
              <input type="password" id="currentPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label for="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
            </div>
            
            <button type="submit" class="edit-profile-btn">Change Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut,
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      getDocs,
      query,
      where,
      updateDoc,
      onSnapshot,
      setDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBdDwCslP5RGHi37xjFo89x8rY3kKbhUwQ",
      authDomain: "semulight-db.firebaseapp.com",
      projectId: "semulight-db",
      storageBucket: "semulight-db.firebasestorage.app",
      messagingSenderId: "693934626490",
      appId: "1:693934626490:web:87c36c26026509f86f1483",
      measurementId: "G-QFFLDWLW2L"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let userData = null;
    let userStats = null;
    let userDonations = [];
    let userForumRegistrations = [];

    // DOM elements
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");
    const profileForm = document.getElementById("profileForm");
    const passwordForm = document.getElementById("passwordForm");
    const editProfileBtn = document.getElementById("editProfileBtn");
    const donationList = document.getElementById("donationList");
    const historySummary = document.getElementById("historySummary");
    const forumList = document.getElementById("forumList");
    const forumSummary = document.getElementById("forumSummary");

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
      try {
        if (user) {
          currentUser = user;
          console.log("User authenticated:", user.uid);
          
          // Update UI untuk user yang logged in
          document.getElementById('logInBtn').style.display = 'none';
          document.getElementById('signUpBtn').style.display = 'none';
          document.getElementById('logOutBtn').style.display = 'inline-block';
          document.getElementById('userRole').style.display = 'inline-block';
          document.getElementById('userRole').textContent = "User";
          
          await loadUserData();
          await loadUserStats();
          await loadUserDonations();
          await loadUserForumRegistrations();
          
          setupRealtimeListeners();
        } else {
          console.log("No user signed in, redirecting to login...");
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error("Authentication error:", error);
        showError("Authentication failed. Please try logging in again.");
      }
    });

    // Tab functionality
    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        tabBtns.forEach(b => b.classList.remove("active"));
        tabContents.forEach(c => c.classList.remove("active"));
        
        btn.classList.add("active");
        const tabId = btn.getAttribute("data-tab");
        document.getElementById(`${tabId}-tab`).classList.add("active");
      });
    });

    // Load user profile data dengan join date dari Firebase Auth
    async function loadUserData() {
      try {
        console.log("Loading user data for:", currentUser.uid);
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        
        if (userDoc.exists()) {
          userData = userDoc.data();
          console.log("User data loaded:", userData);
          
          // Gunakan metadata dari Firebase Auth untuk join date
          if (!userData.joinDate && currentUser.metadata.creationTime) {
            userData.joinDate = currentUser.metadata.creationTime;
          }
          
          if (!userData.name) {
            userData.name = currentUser.email.split('@')[0];
          }
          
          updateProfileUI();
        } else {
          console.log("User document doesn't exist, creating new one...");
          
          // Gunakan creationTime dari Firebase Auth
          const joinDate = currentUser.metadata.creationTime || new Date().toISOString();
          
          userData = {
            name: currentUser.email.split('@')[0],
            email: currentUser.email,
            phone: "",
            state: "",
            notifications: { email: true, sms: false },
            joinDate: joinDate,
            createdAt: serverTimestamp(),
            level: 1,
            xp: 0,
            totalDonations: 0,
            totalQuantity: 0,
            role: "user"
          };
          
          await setDoc(doc(db, "users", currentUser.uid), userData);
          console.log("New user document created");
          updateProfileUI();
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        showError("Failed to load user profile. Please refresh the page.");
      }
    }

    // Load user statistics - including forum registrations
    async function loadUserStats() {
      try {
        console.log("Loading user stats...");
        
        // Query donations
        const donationsQuery = query(
          collection(db, "donations"),
          where("userId", "==", currentUser.uid)
        );
        
        const donationsSnapshot = await getDocs(donationsQuery);
        let totalQuantity = 0;
        let totalDonations = 0;
        let donationPoints = 0;
        let uniqueEvents = new Set();
        
        donationsSnapshot.forEach((doc) => {
          const donation = doc.data();
          const quantity = parseFloat(donation.quantity) || 0;
          totalQuantity += quantity;
          totalDonations++;
          
          if (donation.eventId) {
            uniqueEvents.add(donation.eventId);
          }
          
          const pointsForThisDonation = Math.round(quantity * 1);
          donationPoints += pointsForThisDonation;
        });
        
        const uniqueEventsCount = uniqueEvents.size;
        const eventParticipationPoints = calculateEventParticipationPoints(uniqueEventsCount);
        
        // Query forum registrations
        const forumRegistrationsQuery = query(
          collection(db, "forum_registrations"),
          where("userId", "==", currentUser.uid)
        );
        
        const forumRegistrationsSnapshot = await getDocs(forumRegistrationsQuery);
        let forumRegistrationsCount = 0;
        let uniqueForumEvents = new Set();
        
        forumRegistrationsSnapshot.forEach((doc) => {
          const registration = doc.data();
          forumRegistrationsCount++;
          
          if (registration.eventId) {
            uniqueForumEvents.add(registration.eventId);
          }
        });
        
        const forumPoints = forumRegistrationsCount; // 1 point per registration
        
        // Total points calculation
        const totalPoints = 5 + donationPoints + eventParticipationPoints + forumPoints;
        
        userStats = {
          totalPoints: totalPoints,
          totalDonations: totalDonations,
          totalQuantity: totalQuantity,
          donationPoints: donationPoints,
          eventsJoined: uniqueEventsCount,
          eventParticipationPoints: eventParticipationPoints,
          forumRegistrations: forumRegistrationsCount,
          forumPoints: forumPoints,
          uniqueForumEvents: uniqueForumEvents.size
        };
        
        console.log("User stats loaded:", userStats);
        updateStatsUI();
      } catch (error) {
        console.error("Error loading user stats:", error);
        showError("Failed to load user statistics. Some data may not display correctly.");
        
        // Fallback stats
        userStats = {
          totalPoints: 5,
          totalDonations: 0,
          totalQuantity: 0,
          donationPoints: 0,
          eventsJoined: 0,
          eventParticipationPoints: 0,
          forumRegistrations: 0,
          forumPoints: 0,
          uniqueForumEvents: 0
        };
        updateStatsUI();
      }
    }

    // Load user donation history
    async function loadUserDonations() {
      try {
        console.log("Loading donation history...");
        donationList.innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading your donation history...</p>
          </div>
        `;

        const donationsQuery = query(
          collection(db, "donations"),
          where("userId", "==", currentUser.uid)
        );
        
        const querySnapshot = await getDocs(donationsQuery);
        userDonations = [];
        
        let totalQuantity = 0;
        let totalPoints = 0;

        querySnapshot.forEach((doc) => {
          const donation = doc.data();
          donation.id = doc.id;
          
          // Handle timestamp conversion safely
          if (donation.timestamp && typeof donation.timestamp.toDate === 'function') {
            donation.timestamp = donation.timestamp.toDate();
          } else if (donation.timestamp) {
            donation.timestamp = new Date(donation.timestamp);
          } else {
            donation.timestamp = new Date();
          }
          
          userDonations.push(donation);
          
          const quantity = parseFloat(donation.quantity) || 0;
          totalQuantity += quantity;
          totalPoints += Math.round(quantity * 1);
        });

        // Sort secara manual di client side berdasarkan timestamp (descending)
        userDonations.sort((a, b) => b.timestamp - a.timestamp);

        console.log(`Loaded ${userDonations.length} donations`);

        if (userDonations.length === 0) {
          showEmptyDonationState();
        } else {
          updateDonationSummary(totalQuantity, totalPoints);
          displayDonations(userDonations);
        }
      } catch (error) {
        console.error("Error loading donations:", error);
        
        donationList.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Data</h3>
            <p>There was a problem loading your donation history: ${error.message}</p>
            <p><small>Try refreshing the page or contact support if the problem persists.</small></p>
          </div>
        `;
        
        historySummary.style.display = 'none';
      }
    }

    // Load user forum registrations
    async function loadUserForumRegistrations() {
      try {
        console.log("Loading forum registrations...");
        forumList.innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading your forum activity...</p>
          </div>
        `;

        const forumRegistrationsQuery = query(
          collection(db, "forum_registrations"),
          where("userId", "==", currentUser.uid)
        );
        
        const querySnapshot = await getDocs(forumRegistrationsQuery);
        userForumRegistrations = [];
        
        // Get event details for each registration
        for (const doc of querySnapshot.docs) {
          const registration = doc.data();
          registration.id = doc.id;
          
          // Handle timestamp conversion
          if (registration.registrationDate && typeof registration.registrationDate.toDate === 'function') {
            registration.registrationDate = registration.registrationDate.toDate();
          } else if (registration.registrationDate) {
            registration.registrationDate = new Date(registration.registrationDate);
          } else {
            registration.registrationDate = new Date();
          }
          
          // Get event details
          if (registration.eventId) {
            try {
              const eventDoc = await getDoc(doc(db, "forum_events", registration.eventId));
              if (eventDoc.exists()) {
                registration.eventData = eventDoc.data();
              }
            } catch (error) {
              console.error("Error fetching event data:", error);
            }
          }
          
          userForumRegistrations.push(registration);
        }

        // Sort by registration date (descending)
        userForumRegistrations.sort((a, b) => b.registrationDate - a.registrationDate);

        console.log(`Loaded ${userForumRegistrations.length} forum registrations`);

        if (userForumRegistrations.length === 0) {
          showEmptyForumState();
        } else {
          updateForumSummary();
          displayForumRegistrations(userForumRegistrations);
        }
      } catch (error) {
        console.error("Error loading forum registrations:", error);
        
        forumList.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Data</h3>
            <p>There was a problem loading your forum activity: ${error.message}</p>
            <p><small>Try refreshing the page or contact support if the problem persists.</small></p>
          </div>
        `;
        
        forumSummary.style.display = 'none';
      }
    }

    // Calculate event participation points
    function calculateEventParticipationPoints(uniqueEventsCount) {
      let points = uniqueEventsCount;
      if (uniqueEventsCount >= 5) points += 10;
      return points;
    }

    // Show empty state for donations
    function showEmptyDonationState() {
      donationList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-oil-can"></i>
          <h3>No Donations Yet</h3>
          <p>You haven't made any donations yet. Start your recycling journey today!</p>
          <a href="Letsdonate.html" class="edit-profile-btn" style="display: inline-block; margin-top: 15px;">
            Make Your First Donation
          </a>
        </div>
      `;
      historySummary.style.display = 'none';
    }

    // Show empty state for forum registrations
    function showEmptyForumState() {
      forumList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comments"></i>
          <h3>No Forum Registrations Yet</h3>
          <p>You haven't registered for any forum events yet. Join the conversation!</p>
          <a href="forum.html" class="edit-profile-btn" style="display: inline-block; margin-top: 15px;">
            Browse Forum Events
          </a>
        </div>
      `;
      forumSummary.style.display = 'none';
    }

    // Update donation summary
    function updateDonationSummary(totalQuantity, totalPoints) {
      const averageQuantity = userDonations.length > 0 ? totalQuantity / userDonations.length : 0;
      
      document.getElementById('summaryTotal').textContent = userDonations.length;
      document.getElementById('summaryQuantity').textContent = totalQuantity.toFixed(1) + ' kg';
      document.getElementById('summaryPoints').textContent = totalPoints + ' pts';
      document.getElementById('summaryAverage').textContent = averageQuantity.toFixed(1) + ' kg';
      
      historySummary.style.display = 'grid';
    }

    // Update forum summary
    function updateForumSummary() {
      document.getElementById('forumTotal').textContent = userForumRegistrations.length;
      document.getElementById('forumUnique').textContent = userStats.uniqueForumEvents;
      document.getElementById('forumPoints').textContent = userStats.forumPoints + ' pts';
      
      forumSummary.style.display = 'grid';
    }

    // Display donations dengan design yang baik
    function displayDonations(donations) {
      let donationsHTML = '';
      
      donations.forEach((donation, index) => {
        const date = donation.timestamp.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        
        const time = donation.timestamp.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const quantity = parseFloat(donation.quantity) || 0;
        const points = Math.round(quantity * 1);
        
        // Determine icon based on quantity
        let icon = 'fa-oil-can';
        if (quantity >= 10) icon = 'fa-tint';
        if (quantity >= 20) icon = 'fa-industry';
        
        donationsHTML += `
          <div class="history-item">
            <div class="history-icon">
              <i class="fas ${icon}"></i>
            </div>
            <div class="history-details">
              <h4>${donation.eventName || "General Donation"}</h4>
              <p>Donated ${quantity.toFixed(1)} kg of used cooking oil</p>
              <div class="history-meta">
                <span class="meta-item">
                  <i class="far fa-calendar"></i> ${date}
                </span>
                <span class="meta-item">
                  <i class="far fa-clock"></i> ${time}
                </span>
                ${donation.eventId ? `<span class="event-badge">Event</span>` : ''}
                <span class="quantity-badge">${quantity.toFixed(1)} kg</span>
                ${donation.station ? `<span class="station-badge">${donation.station}</span>` : ''}
              </div>
            </div>
            <div class="history-points">
              <span>+${points}</span>
              <div class="points-label">points earned</div>
            </div>
          </div>
        `;
      });
      
      donationList.innerHTML = donationsHTML;
    }

    // Display forum registrations
    function displayForumRegistrations(registrations) {
      let forumHTML = '';
      
      registrations.forEach((registration, index) => {
        const date = registration.registrationDate.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        
        const time = registration.registrationDate.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const eventTitle = registration.eventData?.title || "Forum Event";
        const eventDescription = registration.eventData?.description || "Join the discussion!";
        
        forumHTML += `
          <div class="history-item">
            <div class="history-icon">
              <i class="fas fa-comments"></i>
            </div>
            <div class="history-details">
              <h4>${eventTitle}</h4>
              <p>${eventDescription}</p>
              <div class="history-meta">
                <span class="meta-item">
                  <i class="far fa-calendar"></i> ${date}
                </span>
                <span class="meta-item">
                  <i class="far fa-clock"></i> ${time}
                </span>
                <span class="event-badge">Forum Registration</span>
              </div>
            </div>
            <div class="history-points">
              <span>+1</span>
              <div class="points-label">points earned</div>
            </div>
          </div>
        `;
      });
      
      forumList.innerHTML = forumHTML;
    }

    // Update profile UI dengan join date dari Firebase Auth
    function updateProfileUI() {
      if (!userData) return;
      
      document.getElementById("userName").textContent = userData.name || "User";
      document.getElementById("userEmail").textContent = userData.email;
      
      // Format join date - prioritaskan dari Firebase Auth metadata
      let joinDate;
      if (currentUser.metadata && currentUser.metadata.creationTime) {
        joinDate = new Date(currentUser.metadata.creationTime);
      } else if (userData.joinDate) {
        joinDate = new Date(userData.joinDate);
      } else if (userData.createdAt) {
        joinDate = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
      } else {
        joinDate = new Date();
      }
      
      document.getElementById("memberSince").textContent = joinDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long',
        day: 'numeric'
      });
      
      // Set avatar initials
      const displayName = userData.name || "User";
      const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById("userAvatar").textContent = initials;
      
      // Update level badge
      document.getElementById("userLevel").textContent = `Level ${userData.level || 1}`;
      
      // Update form fields
      document.getElementById("displayName").value = userData.name || "";
      document.getElementById("email").value = userData.email || "";
      document.getElementById("phone").value = userData.phone || "";
      document.getElementById("state").value = userData.state || "";
      
      if (userData.notifications) {
        document.getElementById("emailNotifications").checked = userData.notifications.email || false;
        document.getElementById("smsNotifications").checked = userData.notifications.sms || false;
      }
    }

    // Update stats UI
    function updateStatsUI() {
      if (!userStats) return;
      
      document.getElementById("totalPoints").textContent = userStats.totalPoints.toLocaleString();
      document.getElementById("totalDonations").textContent = userStats.totalDonations;
      document.getElementById("totalQuantity").textContent = userStats.totalQuantity.toFixed(1) + " kg";
      document.getElementById("eventsJoined").textContent = userStats.eventsJoined;
      document.getElementById("uniqueEvents").textContent = userStats.eventsJoined;
      document.getElementById("forumRegistrations").textContent = userStats.forumRegistrations;
      document.getElementById("forumEvents").textContent = userStats.uniqueForumEvents + " events";
      
      // Update level progress
      if (userData) {
        const currentLevel = userData.level || 1;
        const currentXP = userData.xp || 0;
        const nextLevelXP = currentLevel * 100;
        
        document.getElementById("currentLevel").textContent = currentLevel;
        document.getElementById("currentXP").textContent = currentXP;
        document.getElementById("nextLevelXP").textContent = nextLevelXP;
        
        const progressPercent = (currentXP / nextLevelXP) * 100;
        document.getElementById("levelProgress").style.width = `${Math.min(progressPercent, 100)}%`;
      }
      
      updatePointsBreakdown();
    }

    // Update points breakdown
    function updatePointsBreakdown() {
      if (!userStats) return;
      
      const signupBonus = 5;
      const donationPoints = userStats.donationPoints || 0;
      const eventPoints = userStats.eventParticipationPoints || 0;
      const forumPoints = userStats.forumPoints || 0;
      
      document.getElementById("pointsBreakdown").innerHTML = `
        <h3>Points Breakdown</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 15px;">
          <div class="points-item">
            <span>Sign Up Bonus</span>
            <span>${signupBonus} pts</span>
          </div>
          <div class="points-item">
            <span>Donation Points (${userStats.totalQuantity} kg × 1 pt/kg)</span>
            <span>${donationPoints} pts</span>
          </div>
          <div class="points-item">
            <span>Event Participation (${userStats.eventsJoined} events)</span>
            <span>${eventPoints} pts</span>
          </div>
          <div class="points-item">
            <span>Forum Registrations (${userStats.forumRegistrations} events)</span>
            <span>${forumPoints} pts</span>
          </div>
          <div class="points-total" style="border-top: 1px solid #ddd; padding-top: 10px; font-weight: bold;">
            <span>Total Points</span>
            <span>${userStats.totalPoints.toLocaleString()} pts</span>
          </div>
        </div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
          <i class="fas fa-info-circle"></i> 
          Donation rate: 1 point per 1 kg of used cooking oil<br>
          Forum registration: 1 point per event registration
        </div>
      `;
    }

    // Setup real-time listeners
    function setupRealtimeListeners() {
      try {
        // Real-time listener for user data
        const userDocRef = doc(db, "users", currentUser.uid);
        onSnapshot(userDocRef, (doc) => {
          if (doc.exists()) {
            userData = doc.data();
            updateProfileUI();
          }
        }, (error) => {
          console.error("Error in user data listener:", error);
        });
        
        // Real-time listener for donations
        const donationsQuery = query(
          collection(db, "donations"),
          where("userId", "==", currentUser.uid)
        );
        
        onSnapshot(donationsQuery, (snapshot) => {
          userDonations = [];
          let totalQuantity = 0;
          let totalPoints = 0;

          snapshot.forEach((doc) => {
            const donation = doc.data();
            donation.id = doc.id;
            
            if (donation.timestamp && typeof donation.timestamp.toDate === 'function') {
              donation.timestamp = donation.timestamp.toDate();
            } else if (donation.timestamp) {
              donation.timestamp = new Date(donation.timestamp);
            } else {
              donation.timestamp = new Date();
            }
            
            userDonations.push(donation);
            
            const quantity = parseFloat(donation.quantity) || 0;
            totalQuantity += quantity;
            totalPoints += Math.round(quantity * 1);
          });

          // Sort manually di client
          userDonations.sort((a, b) => b.timestamp - a.timestamp);

          loadUserStats();
          if (userDonations.length === 0) {
            showEmptyDonationState();
          } else {
            updateDonationSummary(totalQuantity, totalPoints);
            displayDonations(userDonations);
          }
        }, (error) => {
          console.error("Error in donations listener:", error);
        });

        // Real-time listener for forum registrations
        const forumRegistrationsQuery = query(
          collection(db, "forum_registrations"),
          where("userId", "==", currentUser.uid)
        );
        
        onSnapshot(forumRegistrationsQuery, (snapshot) => {
          loadUserStats();
          loadUserForumRegistrations();
        }, (error) => {
          console.error("Error in forum registrations listener:", error);
        });
      } catch (error) {
        console.error("Error setting up real-time listeners:", error);
      }
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Error:</strong> ${message}
      `;
      
      const profileContainer = document.querySelector('.profile-container');
      profileContainer.insertBefore(errorDiv, profileContainer.firstChild);
      
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv);
        }
      }, 10000);
    }

    // Form submission handlers
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      try {
        const updatedData = {
          name: document.getElementById("displayName").value,
          phone: document.getElementById("phone").value,
          state: document.getElementById("state").value,
          notifications: {
            email: document.getElementById("emailNotifications").checked,
            sms: document.getElementById("smsNotifications").checked
          },
          updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, "users", currentUser.uid), updatedData);
        alert("Profile updated successfully!");
      } catch (error) {
        console.error("Error updating profile:", error);
        alert("Error updating profile. Please try again.");
      }
    });

    passwordForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      
      if (newPassword !== confirmPassword) {
        alert("Passwords do not match!");
        return;
      }
      
      if (newPassword.length < 6) {
        alert("Password must be at least 6 characters long!");
        return;
      }
      
      try {
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);
        await updatePassword(currentUser, newPassword);
        alert("Password changed successfully!");
        passwordForm.reset();
      } catch (error) {
        console.error("Error changing password:", error);
        
        if (error.code === 'auth/wrong-password') {
          alert("Current password is incorrect. Please try again.");
        } else if (error.code === 'auth/weak-password') {
          alert("New password is too weak. Please choose a stronger password.");
        } else {
          alert("Error changing password. Please check your current password.");
        }
      }
    });

    // Edit profile button functionality
    editProfileBtn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));
      
      document.querySelector('[data-tab="settings"]').classList.add("active");
      document.getElementById("settings-tab").classList.add("active");
    });

    // Log out functionality
    document.getElementById('logOutBtn').addEventListener('click', function() {
      if (confirm("Are you sure you want to log out?")) {
        signOut(auth).then(() => {
          window.location.href = "menu.html";
        }).catch((error) => {
          console.error("Error signing out:", error);
          alert("Error signing out. Please try again.");
        });
      }
    });

    // Navigation auth state handler
    onAuthStateChanged(auth, function(user) {
        if (user) {
            document.getElementById('logInBtn').style.display = 'none';
            document.getElementById('signUpBtn').style.display = 'none';
            document.getElementById('logOutBtn').style.display = 'inline-block';
            document.getElementById('userRole').style.display = 'inline-block';

            const userRef = doc(db, "users", user.uid);
            getDoc(userRef).then((docSnapshot) => {
                if (docSnapshot.exists()) {
                    const role = docSnapshot.data().role;
                    document.getElementById('userRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);
                }
            }).catch((error) => {
                console.error("Error getting user role:", error);
            });
        } else {
            document.getElementById('logInBtn').style.display = 'inline-block';
            document.getElementById('signUpBtn').style.display = 'inline-block';
            document.getElementById('logOutBtn').style.display = 'none';
            document.getElementById('userRole').style.display = 'none';
        }
    });
  </script>
</body>
</html>